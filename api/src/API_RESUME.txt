================================================================================
                     ğŸ  ETNAir - API de Location Type Airbnb
                              RÃ©sumÃ© Complet
================================================================================

================================================================================
                        ğŸ“Š SCHÃ‰MA DE BASE DE DONNÃ‰ES
================================================================================

TABLES ET RELATIONS:
-------------------

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     USERS       â”‚       â”‚      ANNOUNCES      â”‚       â”‚   ANNOUNCES_INFO     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â”€â”€â”    â”‚ id (PK)             â”‚â”€â”€â”€â”€â”€â”€â”€â”‚ id (PK)              â”‚
â”‚ username        â”‚  â”‚    â”‚ user_id (FK)        â”‚       â”‚ announces_id (FK,UQ) â”‚
â”‚ email (UNIQUE)  â”‚  â””â”€â”€â”€â–ºâ”‚ title               â”‚       â”‚ content              â”‚
â”‚ password        â”‚       â”‚ description         â”‚       â”‚ address              â”‚
â”‚ phone           â”‚       â”‚ type (ENUM)         â”‚       â”‚ postal_code          â”‚
â”‚ role (ENUM)     â”‚       â”‚ price               â”‚       â”‚ country              â”‚
â”‚ created_at      â”‚       â”‚ city                â”‚       â”‚ capacity             â”‚
â”‚ updated_at      â”‚       â”‚ is_active           â”‚       â”‚ bedrooms             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ created_at          â”‚       â”‚ bathrooms            â”‚
        â”‚                 â”‚ updated_at          â”‚       â”‚ amenities (JSON)     â”‚
        â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ rules                â”‚
        â”‚                         â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚
        â”‚                         â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â””â”€â”€â”€â”€â”€â”€â–ºâ”‚  ANNOUNCES_PICTURES  â”‚
        â”‚                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                 â”‚ id (PK)              â”‚
        â”‚                                 â”‚ announces_id (FK)    â”‚
        â”‚                                 â”‚ is_cover             â”‚
        â”‚                                 â”‚ url                  â”‚
        â”‚                                 â”‚ filename             â”‚
        â”‚                                 â”‚ created_at           â”‚
        â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    RESERVATIONS     â”‚
                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                  â”‚ id (PK)             â”‚
                  â”‚ user_id (FK)        â”‚
                  â”‚ announce_id (FK)    â”‚
                  â”‚ title               â”‚
                  â”‚ total_price         â”‚
                  â”‚ arrive_at           â”‚
                  â”‚ leave_at            â”‚
                  â”‚ reserved_at         â”‚
                  â”‚ status (ENUM)       â”‚
                  â”‚ city                â”‚
                  â”‚ address             â”‚
                  â”‚ contact_host        â”‚
                  â”‚ guest_count         â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      REVIEWS        â”‚
                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                  â”‚ id (PK)             â”‚
                  â”‚ user_id (FK)        â”‚
                  â”‚ announce_id (FK)    â”‚
                  â”‚ rating (1-5)        â”‚
                  â”‚ comment             â”‚
                  â”‚ created_at          â”‚
                  â”‚ updated_at          â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  (UNIQUE: user_id + announce_id)

TABLE: token_blacklist (pour JWT rÃ©voquÃ©s)
- id, token, expires_at, created_at


ENUMS:
------
UserRole:          USER, ADMIN
AnnounceType:      APARTMENT, HOUSE, VILLA, STUDIO, ROOM, OTHER
ReservationStatus: PENDING, CONFIRMED, CANCELLED, COMPLETED


================================================================================
                           ğŸ›£ï¸ ENDPOINTS API
================================================================================

BASE URL: http://localhost:8080

ENDPOINTS:
  /api/auth         - Authentification
  /api/users        - Utilisateurs
  /api/announces    - Annonces
  /api/reservations - RÃ©servations
  /api/reviews      - Avis/Commentaires

--------------------------------------------------------------------------------
ğŸ” AUTHENTIFICATION (/api/auth)
--------------------------------------------------------------------------------

POST /api/auth/register
  - Description: Inscription d'un nouvel utilisateur
  - Auth requise: NON
  - Body: { username, email, password, phone? }
  - Retourne: { user, accessToken, refreshToken }

POST /api/auth/login
  - Description: Connexion utilisateur
  - Auth requise: NON
  - Body: { email, password }
  - Retourne: { user, accessToken, refreshToken }

POST /api/auth/refresh
  - Description: RafraÃ®chir le token d'accÃ¨s
  - Auth requise: NON
  - Body: { refreshToken }
  - Retourne: { accessToken, refreshToken }

POST /api/auth/logout
  - Description: DÃ©connexion (blacklist le token)
  - Auth requise: OUI
  - Body: { refreshToken? }
  - Retourne: { message }

GET /api/auth/me
  - Description: Profil de l'utilisateur connectÃ©
  - Auth requise: OUI
  - Retourne: User avec ses annonces et rÃ©servations

--------------------------------------------------------------------------------
ğŸ‘¤ UTILISATEURS (/api/users)
--------------------------------------------------------------------------------

GET /api/users
  - Description: Liste tous les utilisateurs
  - Auth requise: NON
  - Query params: page, limit
  - Retourne: User[] ou { data, meta } si paginÃ©

GET /api/users/:id
  - Description: DÃ©tails d'un utilisateur avec ses annonces
  - Auth requise: NON
  - Retourne: User (sans password)

POST /api/users
  - Description: CrÃ©er un utilisateur
  - Auth requise: NON
  - Body: { username, email, password, phone? }
  - Retourne: User crÃ©Ã©

PUT /api/users/:id
  - Description: Modifier un utilisateur
  - Auth requise: OUI
  - Body: { username?, email?, phone? } (password ignorÃ©)
  - Retourne: User modifiÃ©

DELETE /api/users/:id
  - Description: Supprimer un utilisateur
  - Auth requise: OUI
  - Retourne: 204 No Content

--------------------------------------------------------------------------------
ğŸ  ANNONCES (/api/announces)
--------------------------------------------------------------------------------

GET /api/announces
  - Description: Liste les annonces avec filtres
  - Auth requise: NON
  - Query params: page, limit, city, type, minPrice, maxPrice, capacity
  - Retourne: Announce[] avec user, info, pictures

GET /api/announces/:id
  - Description: DÃ©tails d'une annonce
  - Auth requise: NON
  - Retourne: Announce avec toutes les relations

GET /api/announces/user/:userId
  - Description: Annonces d'un utilisateur spÃ©cifique
  - Auth requise: NON
  - Retourne: Announce[]

POST /api/announces
  - Description: CrÃ©er une annonce
  - Auth requise: OUI
  - Body: {
      title, description?, type, price, city?,
      info?: { content?, address?, capacity?, bedrooms?, bathrooms?, amenities?, rules? }
    }
  - Retourne: Announce crÃ©Ã©e

PUT /api/announces/:id
  - Description: Modifier une annonce
  - Auth requise: OUI (propriÃ©taire ou admin)
  - Body: { title?, description?, type?, price?, city?, isActive? }
  - Retourne: Announce modifiÃ©e

DELETE /api/announces/:id
  - Description: Supprimer une annonce
  - Auth requise: OUI (propriÃ©taire ou admin)
  - Retourne: 204 No Content

--------------------------------------------------------------------------------
ğŸ“… RÃ‰SERVATIONS (/api/reservations)
--------------------------------------------------------------------------------

GET /api/reservations
  - Description: Mes rÃ©servations (admin voit tout)
  - Auth requise: OUI
  - Query params: page, limit
  - Retourne: Reservation[]

GET /api/reservations/:id
  - Description: DÃ©tails d'une rÃ©servation
  - Auth requise: OUI (propriÃ©taire, host ou admin)
  - Retourne: Reservation avec announce et user

GET /api/reservations/announce/:announceId
  - Description: RÃ©servations d'une annonce
  - Auth requise: OUI
  - Retourne: Reservation[]

POST /api/reservations
  - Description: CrÃ©er une rÃ©servation
  - Auth requise: OUI
  - Body: { announceId, arriveAt, leaveAt, guestCount?, title? }
  - Note: VÃ©rifie automatiquement la disponibilitÃ© et calcule le prix total
  - Retourne: Reservation crÃ©Ã©e ou erreur 400 si non disponible

POST /api/reservations/check-availability
  - Description: VÃ©rifier la disponibilitÃ© d'une annonce
  - Auth requise: NON
  - Body: { announceId, arriveAt, leaveAt }
  - Retourne: { available: boolean }

PUT /api/reservations/:id
  - Description: Modifier une rÃ©servation (statut)
  - Auth requise: OUI
  - Body: { status } 
  - Note: User peut seulement CANCELLED, host/admin peut tout
  - Retourne: Reservation modifiÃ©e

DELETE /api/reservations/:id
  - Description: Supprimer une rÃ©servation
  - Auth requise: OUI (propriÃ©taire ou admin)
  - Retourne: 204 No Content

--------------------------------------------------------------------------------
â­ AVIS/REVIEWS (/api/reviews)
--------------------------------------------------------------------------------

GET /api/reviews/announce/:announceId
  - Description: Liste les avis d'une annonce
  - Auth requise: NON
  - Query params: page, limit
  - Retourne: Review[] avec user (id, username)

GET /api/reviews/announce/:announceId/rating
  - Description: Note moyenne d'une annonce
  - Auth requise: NON
  - Retourne: { average: number, count: number }

GET /api/reviews/user/:userId
  - Description: Liste les avis d'un utilisateur
  - Auth requise: NON
  - Query params: page, limit
  - Retourne: Review[] avec announce (id, title, city)

GET /api/reviews/:id
  - Description: DÃ©tails d'un avis
  - Auth requise: NON
  - Retourne: Review avec user et announce

POST /api/reviews
  - Description: CrÃ©er un avis (nÃ©cessite une rÃ©servation COMPLETED)
  - Auth requise: OUI
  - Body: { announceId, rating (1-5), comment? }
  - Note: Un utilisateur ne peut laisser qu'un seul avis par annonce
  - Retourne: Review crÃ©Ã© ou erreur 403/409

PUT /api/reviews/:id
  - Description: Modifier un avis
  - Auth requise: OUI (propriÃ©taire ou admin)
  - Body: { rating?, comment? }
  - Retourne: Review modifiÃ©

DELETE /api/reviews/:id
  - Description: Supprimer un avis
  - Auth requise: OUI (propriÃ©taire ou admin)
  - Retourne: 204 No Content


================================================================================
                        ğŸ”’ AUTHENTIFICATION JWT
================================================================================

HEADER:
  Authorization: Bearer <accessToken>

TOKEN PAYLOAD:
  {
    userId: number,
    role: "USER" | "ADMIN",
    iat: timestamp,
    exp: timestamp
  }

DURÃ‰ES:
  - Access Token: 1 heure (3600 secondes)
  - Refresh Token: 7 jours (604800 secondes)

FLUX:
  1. Login/Register â†’ accessToken + refreshToken
  2. RequÃªtes API â†’ Header Authorization: Bearer <accessToken>
  3. Token expirÃ© â†’ POST /api/auth/refresh avec refreshToken
  4. Logout â†’ Token ajoutÃ© Ã  la blacklist


================================================================================
                        ğŸ“¦ FORMATS DE RÃ‰PONSE
================================================================================

LISTE SIMPLE:
  [{ ... }, { ... }, ...]

LISTE PAGINÃ‰E (avec ?page=X&limit=Y):
  {
    "data": [{ ... }, { ... }],
    "meta": {
      "total": 100,
      "page": 1,
      "limit": 10,
      "totalPages": 10
    }
  }

ERREUR:
  {
    "message": "Description de l'erreur",
    "errors": [
      { "field": "email", "message": "Email invalide" }
    ]
  }

CODES HTTP:
  200 - OK (GET, PUT)
  201 - Created (POST)
  204 - No Content (DELETE)
  400 - Bad Request (validation error)
  401 - Unauthorized (pas de token ou token invalide)
  403 - Forbidden (pas les droits)
  404 - Not Found
  409 - Conflict (email dÃ©jÃ  utilisÃ©)
  500 - Internal Server Error


================================================================================
                        ğŸ“ EXEMPLES DE BODY
================================================================================

REGISTER:
{
  "username": "johndoe",
  "email": "john@example.com",
  "password": "password123",
  "phone": "+33612345678"
}

LOGIN:
{
  "email": "john@example.com",
  "password": "password123"
}

CRÃ‰ER ANNONCE:
{
  "title": "Bel appartement au centre de Paris",
  "description": "Appartement lumineux avec vue sur la Tour Eiffel",
  "type": "APARTMENT",
  "price": 150.00,
  "city": "Paris",
  "info": {
    "address": "123 Avenue des Champs-Ã‰lysÃ©es",
    "postalCode": "75008",
    "country": "France",
    "capacity": 4,
    "bedrooms": 2,
    "bathrooms": 1,
    "amenities": "[\"WiFi\",\"Cuisine Ã©quipÃ©e\",\"Parking\",\"Climatisation\"]",
    "rules": "Non-fumeur, pas d'animaux"
  }
}

CRÃ‰ER RÃ‰SERVATION:
{
  "announceId": 1,
  "arriveAt": "2026-02-15T14:00:00.000Z",
  "leaveAt": "2026-02-20T10:00:00.000Z",
  "guestCount": 2,
  "title": "Vacances de fÃ©vrier"
}

VÃ‰RIFIER DISPONIBILITÃ‰:
{
  "announceId": 1,
  "arriveAt": "2026-02-15",
  "leaveAt": "2026-02-20"
}

CRÃ‰ER AVIS:
{
  "announceId": 1,
  "rating": 5,
  "comment": "Superbe sÃ©jour ! L'appartement Ã©tait impeccable et l'hÃ´te trÃ¨s accueillant."
}

MODIFIER AVIS:
{
  "rating": 4,
  "comment": "TrÃ¨s bon sÃ©jour, petit bÃ©mol sur le bruit de la rue."
}


================================================================================
                        ğŸš€ STACK TECHNIQUE
================================================================================

Runtime:      Node.js 18+
Framework:    Express.js 4.x
Langage:      TypeScript 5.x
ORM:          Prisma 5.x
BDD:          PostgreSQL
Auth:         JWT (jsonwebtoken + bcrypt)
Validation:   express-validator
Doc API:      Swagger (swagger-jsdoc + swagger-ui-express)
Tests:        Jest + Supertest
SÃ©curitÃ©:     Helmet, CORS, express-rate-limit
Logging:      Morgan


================================================================================
                        ğŸ¯ FONCTIONNALITÃ‰S CLÃ‰S
================================================================================

1. GESTION DES UTILISATEURS
   - Inscription avec validation email et mot de passe (min 6 caractÃ¨res)
   - Connexion sÃ©curisÃ©e avec bcrypt
   - RÃ´les: USER (standard) et ADMIN (tous les droits)
   - Profil avec annonces et rÃ©servations

2. ANNONCES DE LOGEMENTS
   - CRUD complet
   - 6 types de logements (Appartement, Maison, Villa, Studio, Chambre, Autre)
   - Recherche avec filtres (ville, type, prix min/max, capacitÃ©)
   - Pagination sur les listes
   - Informations dÃ©taillÃ©es (adresse, capacitÃ©, Ã©quipements, rÃ¨gles)
   - Multi-images avec image de couverture

3. RÃ‰SERVATIONS
   - VÃ©rification automatique de disponibilitÃ© (pas de chevauchement)
   - Calcul automatique du prix total (prix/nuit Ã— nombre de nuits)
   - 4 statuts: En attente, ConfirmÃ©e, AnnulÃ©e, TerminÃ©e
   - Gestion des droits (user annule, host confirme)

4. AVIS/REVIEWS
   - Notes de 1 Ã  5 Ã©toiles
   - Commentaires optionnels
   - NÃ©cessite une rÃ©servation COMPLETED pour laisser un avis
   - Un seul avis par utilisateur par annonce
   - Note moyenne calculÃ©e automatiquement
   - PropriÃ©taire ou admin peut modifier/supprimer

5. SÃ‰CURITÃ‰
   - JWT avec expiration
   - Refresh token pour renouvellement
   - Blacklist des tokens rÃ©voquÃ©s
   - Rate limiting (100 req/15min gÃ©nÃ©ral, 10 req/15min auth)
   - Validation des entrÃ©es
   - Protection des routes sensibles

6. STOCKAGE IMAGES
   - Support S3/MinIO pour le stockage
   - URLs pour les images
   - Une image de couverture par annonce


================================================================================
                           ğŸ“ URLs
================================================================================

API:            http://localhost:8080
Documentation:  http://localhost:8080/api-docs
Health Check:   http://localhost:8080/health


================================================================================
                      ğŸ”‘ COMPTE TEST ADMIN
================================================================================

Email:    admin@etnair.com
Password: password123


================================================================================
                    ğŸ’» COMMANDES UTILES
================================================================================

# Installer les dÃ©pendances
npm install

# Lancer en dÃ©veloppement
npm run dev

# GÃ©nÃ©rer le client Prisma
npm run prisma:generate

# Appliquer les migrations
npm run prisma:migrate

# Ouvrir Prisma Studio (GUI BDD)
npm run prisma:studio

# Peupler la base avec des donnÃ©es fictives
npm run seed

# Lancer les tests
npm test

# Lancer les tests avec couverture
npm run test:coverage
